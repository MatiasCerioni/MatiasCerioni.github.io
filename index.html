<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shower Queues</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, remove, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6FfbVvSNZKWhuY3_N4pO_x6dCRr-p5is",
	@@ -20,259 +133,185 @@
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const bathrooms = {
      men: { name: "Ba√±o de Hombres", gender: "M", color: "#1e3a8a" },   // blue
      any: { name: "Ba√±o Mixto", gender: "Any", color: "#065f46" },       // green
      women: { name: "Ba√±o de Mujeres", gender: "F", color: "#9d174d" } // pink
    };

    const people = [
      { name: "Ale", gender: "F" }, { name: "Agus", gender: "F" },
      { name: "Ailen", gender: "F" }, { name: "Cami H.", gender: "F" },
      { name: "Cami Z.", gender: "F" }, { name: "Cata", gender: "F" },
      { name: "Emma", gender: "M" }, { name: "Guido", gender: "M" },
      { name: "Marcos", gender: "M" }, { name: "Marti", gender: "F" },
      { name: "Nico", gender: "M" }, { name: "Pato", gender: "M" },
      { name: "Rom√°n", gender: "M" }, { name: "Sele", gender: "F" },
      { name: "Silvio", gender: "M" }, { name: "Tadeo", gender: "M" },
      { name: "Tomi", gender: "M" }, { name: "Juana", gender: "F" },
      { name: "Zurdo", gender: "M" }
    ];

    let selectedPerson = null;

    function formatTime() {
      return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function renderPeople() {
      const maleContainer = document.getElementById("male-buttons");
      const femaleContainer = document.getElementById("female-buttons");
      maleContainer.innerHTML = "";
      femaleContainer.innerHTML = "";

      const males = people.filter(p => p.gender === "M").sort((a,b) => a.name.localeCompare(b.name));
      const females = people.filter(p => p.gender === "F").sort((a,b) => a.name.localeCompare(b.name));

      males.forEach(person => {
        const btn = document.createElement("button");
        btn.textContent = person.name;
        btn.className = "name-btn";
        btn.onclick = () => selectPerson(person);
        maleContainer.appendChild(btn);
      });

      females.forEach(person => {
        const btn = document.createElement("button");
        btn.textContent = person.name;
        btn.className = "name-btn";
        btn.onclick = () => selectPerson(person);
        femaleContainer.appendChild(btn);
      });
    }

    function selectPerson(person) {
      selectedPerson = person;
      document.getElementById("selectedName").textContent = `Seleccionado: ${person.name}`;
    }

    function addToQueue(useShortest) {
      if (!selectedPerson) {
        alert("Primero eleg√≠ un nombre");
        return;
      }
      const person = selectedPerson;

      if (useShortest) {
        const promises = Object.keys(bathrooms).map(b => get(ref(db, `queues/${b}`)));
        Promise.all(promises).then(snapshots => {
          let shortest = null;
          let shortestLen = Infinity;
          snapshots.forEach((snap, i) => {
            const key = Object.keys(bathrooms)[i];
            const b = bathrooms[key];
            if (b.gender === person.gender || b.gender === "Any") {
              const len = snap.exists() ? Object.keys(snap.val()).length : 0;
              if (len < shortestLen) {
                shortestLen = len;
                shortest = key;
              }
            }
          });
          if (shortest) {
            push(ref(db, `queues/${shortest}`), {
              name: person.name,
              gender: person.gender,
              time: formatTime()
            });
          }
        });
      } else {
        const genderBathroom = Object.keys(bathrooms).find(b => bathrooms[b].gender === person.gender);
        push(ref(db, `queues/${genderBathroom}`), {
          name: person.name,
          gender: person.gender,
          time: formatTime()
        });
      }
    }

    function setupUI() {
      const container = document.getElementById("bathrooms");
      for (const [key, b] of Object.entries(bathrooms)) {
        const div = document.createElement("div");
        div.className = "bathroom";
        div.style.background = b.color;

        div.innerHTML = `
          <h2>${b.name}</h2>
          <div class="current">
            <strong>Adentro:</strong> <span id="${key}-current">Nadie</span>
            <button onclick="nextInQueue('${key}')">Next</button>
          </div>
          <ul id="${key}-queue"></ul>
        `;
        container.appendChild(div);

        onValue(ref(db, `queues/${key}`), snap => {
          const list = document.getElementById(`${key}-queue`);
          list.innerHTML = "";
          if (snap.exists()) {
            Object.entries(snap.val()).forEach(([id, person]) => {
              const li = document.createElement("li");
              li.innerHTML = `${person.name} (${person.time}) 
                <button class="cancel-btn" onclick="cancelFromQueue('${key}','${id}')">‚ùå</button>`;
              list.appendChild(li);
            });
          }
        });

        onValue(ref(db, `current/${key}`), snap => {
          const spot = document.getElementById(`${key}-current`);
          spot.textContent = snap.exists() ? `${snap.val().name} (${snap.val().time})` : "Nadie";
        });
      }
    }

    window.nextInQueue = function(bathroom) {
      get(ref(db, `queues/${bathroom}`)).then(snap => {
        if (snap.exists()) {
          const entries = Object.entries(snap.val());
          const [id, person] = entries[0];
          set(ref(db, `current/${bathroom}`), {
            ...person,
            time: formatTime()
          });
          remove(ref(db, `queues/${bathroom}/${id}`));
        } else {
          set(ref(db, `current/${bathroom}`), null);
        }
      });
    };

    window.cancelFromQueue = function(bathroom, id) {
      remove(ref(db, `queues/${bathroom}/${id}`));
    };

    window.addToQueue = addToQueue;

    renderPeople();
    setupUI();
  </script>

  <style>
    body {
      background: #121212;
      color: #eee;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    h1 {
      margin-bottom: 20px;
    }
    .button-row {
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .name-btn {
      background: #444;
      color: #eee;
      font-size: 16px;
      width: 100%;
    }
    .name-btn:hover {
      background: #666;
    }
    .cancel-btn {
      background: transparent;
      border: none;
      color: red;
      font-size: 18px;
      cursor: pointer;
    }
    .bathroom {
      margin: 10px;
      padding: 15px;
      border-radius: 10px;
      flex: 1;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      color: #fff;
    }
    .current {
      margin-bottom: 10px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      margin: 5px 0;
      font-size: 18px;
    }
    #name-matrix {
      display: flex;
      justify-content: center;
      gap: 80px; /* more space to avoid overlap */
      margin-bottom: 20px;
    }
    #male-buttons, #female-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      max-width: 400px;
    }
    #bathrooms {
      display: flex;
      justify-content: space-around;
      margin-top: 30px;
      gap: 20px;
    }
  </style>
</head>
<body>
  <h1>Filas de Duchas üöø</h1>
  <div id="name-matrix">
    <div>
      <h3>Hombres</h3>
      <div id="male-buttons"></div>
    </div>
    <div>
      <h3>Mujeres</h3>
      <div id="female-buttons"></div>
    </div>
  </div>
  <p id="selectedName">Seleccionado: Ninguno</p>
  <div class="button-row">
    <button onclick="addToQueue(true)">Fila m√°s corta</button>
    <button onclick="addToQueue(false)">Fila de mi g√©nero</button>
  </div>
  <div id="bathrooms"></div>
</body>
</html>
