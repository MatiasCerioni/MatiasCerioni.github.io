<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Shower Queues</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: #eee;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .name-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .name-button {
      padding: 15px 25px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: #333;
      color: #eee;
      transition: background 0.2s;
    }
    .name-button:hover {
      background-color: #555;
    }
    .name-button.selected {
      background-color: #007bff;
      color: white;
    }
    .queue-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .queue-buttons button {
      padding: 15px 30px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: #28a745;
      color: white;
      transition: background 0.2s;
    }
    .queue-buttons button:hover {
      background-color: #218838;
    }
    .bathrooms {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .bathroom {
      background-color: #2c2c2c;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .bathroom h2 {
      margin-top: 0;
    }
    .bathroom button {
      margin-top: 5px;
      margin-bottom: 15px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background-color: #ffc107;
      color: black;
      transition: background 0.2s;
    }
    .bathroom button:hover {
      background-color: #e0a800;
    }
    ul {
      list-style: none;
      padding: 0;
      font-size: 18px;
    }
    li {
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cancel-btn {
      cursor: pointer;
      margin-left: 10px;
      color: red;
      font-size: 20px;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6FfbVvSNZKWhuY3_N4pO_x6dCRr-p5is",
      authDomain: "shower-queues.firebaseapp.com",
      databaseURL: "https://shower-queues-default-rtdb.firebaseio.com",
      projectId: "shower-queues",
      storageBucket: "shower-queues.firebasestorage.app",
      messagingSenderId: "189760261495",
      appId: "1:189760261495:web:2d0d223e749f70b7f2a572"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const users = {
      "Zurdo": "M",
      "Cami Z.": "F",
      "Tomi": "M",
      "Ailen": "F"
    };

    let selectedName = null;

    // Setup name buttons
    window.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("nameButtons");
      Object.keys(users).forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.className = "name-button";
        btn.onclick = () => {
          document.querySelectorAll(".name-button").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          selectedName = name;
        };
        container.appendChild(btn);
      });
    });

    function getCurrentTime() {
      const now = new Date();
      return now.toTimeString().slice(0,5);
    }

    async function joinQueue(type) {
      if (!selectedName) {
        alert("Eleg√≠ un nombre primero!");
        return;
      }
      const gender = users[selectedName];
      const time = getCurrentTime();

      const bathroomsRef = ref(db, "bathrooms");
      const snapshot = await get(bathroomsRef);
      let bathrooms = snapshot.exists() ? snapshot.val() : {};

      if (!bathrooms.men) bathrooms.men = { current: null, queue: {} };
      if (!bathrooms.women) bathrooms.women = { current: null, queue: {} };
      if (!bathrooms.any) bathrooms.any = { current: null, queue: {} };

      let targetBathroom = null;
      if (type === "shortest") {
        let candidates = gender === "M" ? ["men","any"] : ["women","any"];
        targetBathroom = candidates.reduce((minBath, b) => {
          const len = bathrooms[b].queue ? Object.keys(bathrooms[b].queue).length : 0;
          const minLen = bathrooms[minBath].queue ? Object.keys(bathrooms[minBath].queue).length : 0;
          return len < minLen ? b : minBath;
        }, candidates[0]);
      } else if (type === "gender") {
        targetBathroom = gender === "M" ? "men" : "women";
      }

      const queueRef = ref(db, `bathrooms/${targetBathroom}/queue`);
      push(queueRef, { name: selectedName, signupTime: time });
    }
    window.joinShortest = () => joinQueue("shortest");
    window.joinGender = () => joinQueue("gender");

    async function nextPerson(bathroom) {
      const bathRef = ref(db, `bathrooms/${bathroom}`);
      const snapshot = await get(bathRef);
      if (!snapshot.exists()) return;
      const bath = snapshot.val();

      let next = null;
      let newQueue = {};
      if (bath.queue) {
        const keys = Object.keys(bath.queue);
        if (keys.length > 0) {
          const firstKey = keys[0];
          const person = bath.queue[firstKey];
          next = { name: person.name, time: getCurrentTime() }; // entry time
          newQueue = { ...bath.queue };
          delete newQueue[firstKey];
        }
      }

      await set(bathRef, { current: next, queue: newQueue });
    }
    window.nextPerson = nextPerson;

    async function cancelEntry(bathroom, key) {
      const entryRef = ref(db, `bathrooms/${bathroom}/queue/${key}`);
      await remove(entryRef);
    }
    window.cancelEntry = cancelEntry;

    const baths = ["men","women","any"];
    baths.forEach(b => {
      const bathRef = ref(db, `bathrooms/${b}`);
      onValue(bathRef, snapshot => {
        const data = snapshot.val() || { current: null, queue: {} };
        document.getElementById(`${b}-current`).textContent =
          data.current ? `${data.current.name} (${data.current.time})` : "Disponible";

        const ul = document.getElementById(`${b}-queue`);
        ul.innerHTML = "";
        for (const key in data.queue) {
          const entry = data.queue[key];
          const li = document.createElement("li");
          li.textContent = `${entry.name} (${entry.signupTime})`;
          const cancel = document.createElement("span");
          cancel.textContent = "‚ùå";
          cancel.className = "cancel-btn";
          cancel.onclick = () => cancelEntry(b, key);
          li.appendChild(cancel);
          ul.appendChild(li);
        }
      });
    });
  </script>
</head>
<body>
  <h1>Organizador de duchas üöø</h1>

  <div class="name-buttons" id="nameButtons"></div>

  <div class="queue-buttons">
    <button onclick="joinShortest()">Fila m√°s corta</button>
    <button onclick="joinGender()">Fila de mi g√©nero</button>
  </div>

  <div class="bathrooms">
    <div class="bathroom">
      <h2>Ba√±o de Hombres</h2>
      <p><strong>Adentro:</strong> <span id="men-current">Disponible</span></p>
      <button onclick="nextPerson('men')">Next</button>
      <h3>Fila:</h3>
      <ul id="men-queue"></ul>
    </div>

    <div class="bathroom">
      <h2>Ba√±o de Mujeres</h2>
      <p><strong>Adentro:</strong> <span id="women-current">Disponible</span></p>
      <button onclick="nextPerson('women')">Next</button>
      <h3>Fila:</h3>
      <ul id="women-queue"></ul>
    </div>

    <div class="bathroom">
      <h2>Ba√±o Mixto</h2>
      <p><strong>Adentro:</strong> <span id="any-current">Disponible</span></p>
      <button onclick="nextPerson('any')">Next</button>
      <h3>Fila:</h3>
      <ul id="any-queue"></ul>
    </div>
  </div>
</body>
</html>
