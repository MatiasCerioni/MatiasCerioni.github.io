<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Shower Queues</title>
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB6FfbVvSNZKWhuY3_N4pO_x6dCRr-p5is",
      authDomain: "shower-queues.firebaseapp.com",
      databaseURL: "https://shower-queues-default-rtdb.firebaseio.com",
      projectId: "shower-queues",
      storageBucket: "shower-queues.firebasestorage.app",
      messagingSenderId: "189760261495",
      appId: "1:189760261495:web:2d0d223e749f70b7f2a572"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Fixed names and genders
    const users = {
      "Zurdo": "M",
      "Cami Z.": "F",
      "Tomi": "M",
      "Ailen": "F"
    };

    // Dropdown setup
    window.addEventListener("DOMContentLoaded", () => {
      const select = document.getElementById("nameSelect");
      Object.keys(users).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
    });

    // Utility: get current HH:MM
    function getCurrentTime() {
      const now = new Date();
      return now.toTimeString().slice(0,5);
    }

    // Add to queue
    async function joinQueue(type) {
      const name = document.getElementById("nameSelect").value;
      const gender = users[name];
      const time = getCurrentTime();

      const bathroomsRef = ref(db, "bathrooms");
      const snapshot = await get(bathroomsRef);
      let bathrooms = snapshot.exists() ? snapshot.val() : {};

      if (!bathrooms.men) bathrooms.men = { current: null, queue: {} };
      if (!bathrooms.women) bathrooms.women = { current: null, queue: {} };
      if (!bathrooms.any) bathrooms.any = { current: null, queue: {} };

      let targetBathroom = null;

      if (type === "shortest") {
        // Pick the shortest valid queue
        let candidates = [];
        if (gender === "M") candidates = ["men","any"];
        if (gender === "F") candidates = ["women","any"];

        targetBathroom = candidates.reduce((minBath, b) => {
          const len = bathrooms[b].queue ? Object.keys(bathrooms[b].queue).length : 0;
          const minLen = bathrooms[minBath].queue ? Object.keys(bathrooms[minBath].queue).length : 0;
          return len < minLen ? b : minBath;
        }, candidates[0]);
      } else if (type === "gender") {
        targetBathroom = (gender === "M") ? "men" : "women";
      }

      // Add to chosen queue
      const queueRef = ref(db, `bathrooms/${targetBathroom}/queue`);
      push(queueRef, { name, time });
    }

    window.joinShortest = () => joinQueue("shortest");
    window.joinGender = () => joinQueue("gender");

    // Move to next
    async function nextPerson(bathroom) {
      const bathRef = ref(db, `bathrooms/${bathroom}`);
      const snapshot = await get(bathRef);
      if (!snapshot.exists()) return;
      const bath = snapshot.val();

      let next = null;
      let newQueue = {};
      if (bath.queue) {
        const keys = Object.keys(bath.queue);
        if (keys.length > 0) {
          const firstKey = keys[0];
          next = bath.queue[firstKey];
          newQueue = { ...bath.queue };
          delete newQueue[firstKey];
        }
      }

      await set(bathRef, {
        current: next,
        queue: newQueue
      });
    }
    window.nextPerson = nextPerson;

    // Listen for updates and render
    const baths = ["men","women","any"];
    baths.forEach(b => {
      const bathRef = ref(db, `bathrooms/${b}`);
      onValue(bathRef, snapshot => {
        const data = snapshot.val() || { current: null, queue: {} };
        // Current occupant
        document.getElementById(`${b}-current`).textContent =
          data.current ? `${data.current.name} (${data.current.time})` : "Disponible";

        // Queue
        const ul = document.getElementById(`${b}-queue`);
        ul.innerHTML = "";
        for (const key in data.queue) {
          const entry = data.queue[key];
          const li = document.createElement("li");
          li.textContent = `${entry.name} (${entry.time})`;
          ul.appendChild(li);
        }
      });
    });
  </script>
</head>
<body>
  <h1>Organizador de duchas üöø</h1>

  <label for="nameSelect">Eleg√≠ tu nombre:</label>
  <select id="nameSelect"></select>
  <button onclick="joinShortest()">Fila m√°s corta</button>
  <button onclick="joinGender()">Fila de mi g√©nero</button>

  <hr>

  <div>
    <h2>Ba√±o de Hombres</h2>
    <p><strong>Adentro:</strong> <span id="men-current">Disponible</span></p>
    <button onclick="nextPerson('men')">Next</button>
    <h3>Fila:</h3>
    <ul id="men-queue"></ul>
  </div>

  <div>
    <h2>Ba√±o de Mujeres</h2>
    <p><strong>Adentro:</strong> <span id="women-current">Disponible</span></p>
    <button onclick="nextPerson('women')">Next</button>
    <h3>Fila:</h3>
    <ul id="women-queue"></ul>
  </div>

  <div>
    <h2>Ba√±o Mixto</h2>
    <p><strong>Adentro:</strong> <span id="any-current">Disponible</span></p>
    <button onclick="nextPerson('any')">Next</button>
    <h3>Fila:</h3>
    <ul id="any-queue"></ul>
  </div>
</body>
</html>
